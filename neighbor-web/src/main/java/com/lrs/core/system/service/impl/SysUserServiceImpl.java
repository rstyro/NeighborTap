package com.lrs.core.system.service.impl;

import cn.dev33.satoken.session.SaSession;
import cn.dev33.satoken.stp.StpUtil;
import cn.hutool.core.convert.Convert;
import cn.hutool.core.io.FileUtil;
import cn.hutool.core.net.NetUtil;
import cn.hutool.core.util.IdUtil;
import cn.hutool.crypto.SecureUtil;
import cn.hutool.extra.spring.SpringUtil;
import com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.lrs.common.constant.Const;
import com.lrs.common.constant.RedisKey;
import com.lrs.common.constant.SystemConst;
import com.lrs.common.enums.ApiResultEnum;
import com.lrs.common.exception.ServiceException;
import com.lrs.common.utils.RemoteIpUtil;
import com.lrs.common.vo.TabsVo;
import com.lrs.core.config.CommonConfig;
import com.lrs.core.system.dto.BaseDto;
import com.lrs.core.system.dto.LoginDto;
import com.lrs.core.system.entity.SysMenu;
import com.lrs.core.system.entity.SysRoleMenu;
import com.lrs.core.system.entity.SysUser;
import com.lrs.core.system.entity.SysUserRole;
import com.lrs.core.system.event.LoginInfoEvent;
import com.lrs.core.system.mapper.SysUserMapper;
import com.lrs.core.system.service.ISysMenuService;
import com.lrs.core.system.service.ISysRoleMenuService;
import com.lrs.core.system.service.ISysUserRoleService;
import com.lrs.core.system.service.ISysUserService;
import com.lrs.core.util.RedisUtil;
import jakarta.annotation.Resource;
import jakarta.servlet.http.HttpServletRequest;
import org.springframework.stereotype.Service;
import org.springframework.util.CollectionUtils;
import org.springframework.util.ObjectUtils;
import org.springframework.util.StringUtils;

import java.time.LocalDateTime;
import java.util.*;
import java.util.concurrent.TimeUnit;
import java.util.stream.Collectors;

/**
 * <p>
 * 系统用户 服务实现类
 * </p>
 *
 * @author rstyro
 * @since 2023-12-01
 */
@Service
public class SysUserServiceImpl extends ServiceImpl<SysUserMapper, SysUser> implements ISysUserService {
    @Resource
    private ISysUserRoleService sysUserRoleService;

    @Resource
    private ISysRoleMenuService sysMenuRoleService;

    @Resource
    private ISysMenuService sysMenuService;

    @Resource
    private CommonConfig commonConfig;


    /**
     * 获取用户的菜单权限
     *
     * @param userId
     * @return
     */
    @Override
    public List<String> getUserPermissionList(Long userId) {
        return buildPermit(getUserMenuList(userId));
    }

    public List<String> buildPermit(List<SysMenu> sysMenus) {
        Set<String> allPermission = new HashSet<>();
        for (SysMenu sysMenu : sysMenus) {
            if (sysMenu.isHasPermit()) {
                allPermission.add(sysMenu.getPermit());
                if (!CollectionUtils.isEmpty(sysMenu.getChild()) && sysMenu.isHasPermit()) {
                    allPermission.addAll(buildPermit(sysMenu.getChild()));
                }
            }
        }
        return new ArrayList<>(allPermission);
    }


    /**
     * 获取用户的角色ID列表
     *
     * @param userId 用户id
     * @return 角色ID列表
     */
    @Override
    public List<String> getUserRoleList(Long userId) {
        List<SysUserRole> userRoleList = Optional.ofNullable(sysUserRoleService
                .list(new LambdaQueryWrapper<SysUserRole>()
                        .eq(SysUserRole::getUserId, userId))).orElse(new ArrayList<>());
        return userRoleList.stream().map(i -> String.valueOf(i.getRoleId())).collect(Collectors.toList());
    }

    /**
     * 获取用户树形菜单
     *
     * @param userId 用户ID
     */
    @Override
    public List<SysMenu> getUserMenuList(Long userId) {
        //获取所有树形菜单
        List<SysMenu> allMenuTreeList = sysMenuService.getAllMenuList();
        List<String> userRoleList = getUserRoleList(userId);
        // 得到用户有权限的菜单
        List<Long> menuList = Optional.ofNullable(userRoleList)
                .filter(i -> !i.isEmpty())
                .map(list -> sysMenuRoleService.list(new LambdaQueryWrapper<SysRoleMenu>()
                                .in(SysRoleMenu::getRoleId, list))
                        .stream()
                        .map(SysRoleMenu::getMenuId)
                        .collect(Collectors.toList()))
                .orElse(new ArrayList<>());
        // 遍历全菜单，过滤用户有权限的菜单，设置hasPermit字段
        checkPermit(allMenuTreeList, menuList, userId);
        return allMenuTreeList;
    }

    public void checkPermit(List<SysMenu> allMenuTreeList, List<Long> menuList, Long userId) {
        for (SysMenu sysMenu : allMenuTreeList) {
            //判断菜单是否有查看权限,1=admin 超级管理员相当可无视规则得到所有权限
            sysMenu.setHasPermit(menuList.contains(sysMenu.getId()) || userId==1);
            if (!ObjectUtils.isEmpty(sysMenu.getChild())) {
                checkPermit(sysMenu.getChild(), menuList, userId);
            }
        }
    }

    /**
     * 只返回用户拥有权限的菜单
     *
     * @param userId
     * @return
     */
    @Override
    public List<TabsVo> getTabMenuList(Long userId) {
        List<SysMenu> userMenuList = getUserMenuList(StpUtil.getLoginId(0l));
        return userMenuList.stream()
                .filter(SysMenu::isHasPermit)
                .map(this::convertToTabsVo)
                .collect(Collectors.toList());
    }

    @Override
    public Page<SysUser> getUserPage(Page page, BaseDto dto) {
        LambdaQueryWrapper<SysUser> queryWrapper = new LambdaQueryWrapper<>();
        // 排除密码字段和盐字段
        queryWrapper.select(SysUser.class, i -> !i.getColumn().equals("password") && !i.getColumn().equals("salt"));
        if (!ObjectUtils.isEmpty(dto.getKeyword())) {
            queryWrapper.like(SysUser::getNickName, dto.getKeyword());
            queryWrapper.or().like(SysUser::getUsername, dto.getKeyword());
        }
        queryWrapper.orderByDesc(SysUser::getCreateTime);
        return page(page, queryWrapper);
    }

    @Override
    public boolean add(SysUser item) {
        checkUserName(item);
        String salt = IdUtil.fastSimpleUUID();
        item.setSalt(salt);
        item.setPassword(SecureUtil.md5(item.getPassword() + salt));
        return save(item);
    }

    public void checkUserName(SysUser item) {
        long count = count(new LambdaQueryWrapper<SysUser>().eq(SysUser::getUsername, item.getUsername()));
        if (count > 0) {
            throw new ServiceException(ApiResultEnum.SYSTEM_USER_EXIST);
        }
    }

    @Override
    public boolean edit(SysUser item) {
        SysUser sysUser = getById(item.getId());
        if (sysUser == null) {
            throw new ServiceException(ApiResultEnum.SYSTEM_USER_NOT_FOUND);
        }
        // 重命名判断
        if (!sysUser.getUsername().equals(item.getUsername())) {
            SysUser existingUser = getOne(new LambdaQueryWrapper<SysUser>().eq(SysUser::getUsername, item.getUsername()));
            if (existingUser != null && !existingUser.getId().equals(item.getId())) {
                throw new ServiceException(ApiResultEnum.SYSTEM_USER_EXIST);
            }
        }

        // 删除旧头像
        if(!ObjectUtils.isEmpty(item.getAvatar()) && !Objects.equals(item.getAvatar(), sysUser.getAvatar())) {
            FileUtil.del(commonConfig.getUpload().getRoot() + sysUser.getAvatar().replace("/show",""));
        }

        // 密码盐从初始化后，不可更改
        item.setSalt(null);
        if (!ObjectUtils.isEmpty(item.getPassword())) {
            item.setPassword(SecureUtil.md5(item.getPassword() + sysUser.getSalt()));
        }
        boolean update = updateById(item);
        if (update && sysUser.getId().equals(StpUtil.getLoginIdAsLong())) {
            // 刷新用户session
            StpUtil.getSession().set(Const.SessionKey.SESSION_USER, getById(item.getId()));
        }
        return update;
    }

    @Override
    public boolean del(Long id) {
        return removeById(id);
    }

    @Override
    public boolean batchDel(List<Long> ids) {
        return removeBatchByIds(ids);
    }

    @Override
    public SysUser login(HttpServletRequest request, LoginDto dto) {
        String errKey = RedisKey.USER_ACCOUNT_ERR_KEY + dto.getUsername() + RemoteIpUtil.getRemoteIp(request);
        // 检查账户是否被锁定
        checkAccountLocked(request, dto.getUsername(), errKey);
        // 验证码校验
        validateCaptcha(request, dto, errKey);

        SysUser sysUser = this.getOne(new LambdaQueryWrapper<SysUser>().eq(SysUser::getUsername, dto.getUsername()));
        // 用户存在性检查
        validateUserExists(request, dto, sysUser, errKey);

        // 登录成功处理
        handleLoginSuccess(request,dto,sysUser,errKey);
        return sysUser;
    }

    /**
     * 检查账户是否被锁定
     */
    private void checkAccountLocked(HttpServletRequest request, String username, String errKey) {
        Integer errorCount = RedisUtil.get(errKey, Integer.class);
        int maxRetryCount = commonConfig.getUser().getMaxRetryCount();

        if (errorCount != null && errorCount >= maxRetryCount) {
            recordLoginInfo(request, username, SystemConst.LoginInfoStatus.FAIL,
                    ApiResultEnum.SYSTEM_USER_ABOVE_MAX_RETRY_COUNT.getMessage());
            throw new ServiceException(ApiResultEnum.SYSTEM_USER_ABOVE_MAX_RETRY_COUNT);
        }
    }

    /**
     * 验证码校验
     */
    private void validateCaptcha(HttpServletRequest request, LoginDto dto, String errKey) {
        String sessionCode = (String) request.getSession().getAttribute(Const.SessionKey.SESSION_CODE);

        if (!StringUtils.hasText(sessionCode) || !sessionCode.equalsIgnoreCase(dto.getCode())) {
            handleLoginError(request, dto.getUsername(), errKey,
                    ApiResultEnum.SYSTEM_CODE_ERROR.getMessage());
            throw new ServiceException(ApiResultEnum.SYSTEM_CODE_ERROR);
        }
    }

    /**
     * 处理登录错误
     */
    private void handleLoginError(HttpServletRequest request, String username,String errKey, String errorMsg) {
        // 原子性增加错误次数
        CommonConfig.UserConfig userConfig = commonConfig.getUser();
        Long errorCount = RedisUtil.incr(errKey, 1L);
        int maxRetryCount = userConfig.getMaxRetryCount();
        // 如果是第一次错误，设置过期时间
        if (errorCount == 1) {
            RedisUtil.expire(errKey, userConfig.getLockTime(), TimeUnit.MINUTES);
        }
        String detailedMsg = errorCount >= maxRetryCount ?
                "账户已被锁定，请" + userConfig.getLockTime() + "分钟后再试" :
                String.format("密码错误，还剩%d次尝试机会", maxRetryCount - errorCount);
        recordLoginInfo(request, username, SystemConst.LoginInfoStatus.FAIL, errorMsg + " | " + detailedMsg);
        if (errorCount >= maxRetryCount) {
            throw new ServiceException(detailedMsg);
        }
    }

    /**
     * 验证用户存在性
     */
    private void validateUserExists(HttpServletRequest request, LoginDto dto,SysUser sysUser, String errKey) {
        if (sysUser == null) {
            handleLoginError(request, dto.getUsername(), errKey,
                    ApiResultEnum.SYSTEM_ACCOUNT_NOT_FOUND.getMessage());
            throw new ServiceException(ApiResultEnum.SYSTEM_ACCOUNT_NOT_FOUND);
        }

        String encryptedPassword = SecureUtil.md5(dto.getPassword() + sysUser.getSalt());
        if (!encryptedPassword.equals(sysUser.getPassword())) {
            handleLoginError(request, dto.getUsername(), errKey,
                    ApiResultEnum.SYSTEM_PASSWORD_ERROR.getMessage());
            throw new ServiceException(ApiResultEnum.SYSTEM_PASSWORD_ERROR);
        }
    }

    /**
     * 登录成功处理
     */
    private SysUser handleLoginSuccess(HttpServletRequest request, LoginDto dto,SysUser sysUser, String errKey) {
        // 清除错误计数
        RedisUtil.del(errKey);
        // 执行登录
        StpUtil.login(sysUser.getId(), dto.isRememberMe());
        // 记录登录信息
        recordLoginInfo(request, dto.getUsername(), SystemConst.LoginInfoStatus.SUCCESS, "登录成功");
        // 更新用户登录记录
        updateUserRecord(sysUser,request);
        // 设置session
        SaSession session = StpUtil.getSession();
        session.set(Const.SessionKey.SESSION_USER, sysUser);

        // 数据脱敏
        sysUser.setPassword("****");
        sysUser.setSalt("****");
        return sysUser;
    }

    @Override
    public boolean logout(HttpServletRequest request) {
        SysUser sysUser = Convert.convert(SysUser.class, StpUtil.getSession().get(Const.SessionKey.SESSION_USER));
        recordLoginInfo(request, sysUser.getUsername(), SystemConst.LoginInfoStatus.SUCCESS, "退出登录");
        StpUtil.logout();
        return true;
    }

    /**
     * 记录登录信息
     *
     * @param request  request
     * @param username 用户名
     * @param status   状态
     * @param message  消息内容
     */
    public void recordLoginInfo(HttpServletRequest request, String username, String status, String message) {
        LoginInfoEvent loginInfoEvent = new LoginInfoEvent();
        loginInfoEvent.setLoginName(username);
        loginInfoEvent.setStatus(status);
        loginInfoEvent.setMsg(message);
        loginInfoEvent.setCreateTime(LocalDateTime.now());
        loginInfoEvent.setInfo(request);
        SpringUtil.getApplicationContext().publishEvent(loginInfoEvent);
    }

    public void updateUserRecord(SysUser sysUser,HttpServletRequest request) {
        // 更新最后登录时间
        SysUser updateUser = new SysUser();
        updateUser.setId(sysUser.getId());
        updateUser.setLoginDate(LocalDateTime.now());
        updateUser.setLoginIp(RemoteIpUtil.getRemoteIp(request));
        updateUser.setUpdateTime(LocalDateTime.now());
        this.updateById(updateUser);
    }

    /**
     * 转换为前端页面tab菜单
     *
     * @param menu
     * @return
     */
    private TabsVo convertToTabsVo(SysMenu menu) {
        TabsVo tabsVo = new TabsVo();
        tabsVo.setIcon(menu.getIcon());
        tabsVo.setId(String.valueOf(menu.getId()));
        tabsVo.setText(menu.getMenuName());
        tabsVo.setUrl(menu.getMenuUrl());
        List<TabsVo> child = Optional.ofNullable(menu.getChild())
                .orElse(Collections.emptyList()).stream()
                .filter(SysMenu::isHasPermit)
                .filter(i -> i.getMenuType().equals(1) || i.getMenuType().equals(0))
                .map(this::convertToTabsVo)
                .collect(Collectors.toList());
        tabsVo.setChildren(child);
        return tabsVo;
    }
}
